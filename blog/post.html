<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post | Bitroot Blog</title>
    <meta name="description" content="Read this article on the Bitroot blog.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/blog.css">
    <link rel="stylesheet" href="css/post.css">

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- SVG grain filter for gradient texture -->
    <svg style="position:absolute;width:0;height:0;" aria-hidden="true">
        <filter id="grain">
            <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/>
            <feColorMatrix type="saturate" values="0"/>
            <feBlend in="SourceGraphic" mode="multiply"/>
        </filter>
    </svg>

    <!-- Minimal Header -->
    <header class="header">
        <nav class="nav">
            <a href="/" class="logo">bitroot</a>
            <div class="nav-links">
                <a href="/blog" class="nav-link">blog</a>
                <a href="/" class="nav-link">home</a>
            </div>
        </nav>
    </header>

    <!-- Post Content -->
    <main class="post-page">
        <article class="post-article" id="post-content">
            <div class="post-loading">Loading...</div>
        </article>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <span class="footer-text">&copy; 2026 Bitroot</span>
            <div class="footer-links">
                <a href="https://github.com/bitroot-org" class="footer-link">GitHub</a>
                <a href="https://twitter.com/bitrootorg" class="footer-link">Twitter</a>
                <a href="/rss.xml" class="footer-link">RSS</a>
            </div>
        </div>
    </footer>

    <script>
        /**
         * Parse YAML frontmatter from markdown content
         */
        function parseFrontmatter(content) {
            const match = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
            if (!match) {
                return { metadata: {}, content };
            }

            const yamlStr = match[1];
            const markdownContent = match[2];

            const metadata = {};
            const lines = yamlStr.split('\n');
            let currentKey = null;
            let currentArray = null;

            for (const line of lines) {
                if (line.match(/^\s+-\s+/)) {
                    const value = line.replace(/^\s+-\s+/, '').trim();
                    if (currentArray && currentKey) {
                        metadata[currentKey].push(value.replace(/^["']|["']$/g, ''));
                    }
                    continue;
                }

                const kvMatch = line.match(/^(\w+):\s*(.*)$/);
                if (kvMatch) {
                    const [, key, value] = kvMatch;
                    currentKey = key;

                    if (value === '' || value === '[]') {
                        metadata[key] = [];
                        currentArray = true;
                    } else if (value.startsWith('[') && value.endsWith(']')) {
                        metadata[key] = value
                            .slice(1, -1)
                            .split(',')
                            .map(s => s.trim().replace(/^["']|["']$/g, ''));
                        currentArray = false;
                    } else {
                        metadata[key] = value.replace(/^["']|["']$/g, '');
                        currentArray = false;
                    }
                }
            }

            return { metadata, content: markdownContent };
        }

        /**
         * Format date for display (uses browser locale)
         */
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const locale = navigator.language || 'en-US';
            return date.toLocaleDateString(locale, {
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });
        }

        /**
         * Format date with time for display (uses browser locale)
         */
        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const locale = navigator.language || 'en-US';
            return date.toLocaleString(locale, {
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        /**
         * Get fallback image based on tag
         */
        function getTagImage(tags) {
            const tagImages = {
                'ai': 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&h=500&fit=crop',
                'engineering': 'https://images.unsplash.com/photo-1555066931-4365d14bab8c?w=800&h=500&fit=crop',
                'design': 'https://images.unsplash.com/photo-1545235617-9465d2a55698?w=800&h=500&fit=crop',
                'tutorial': 'https://images.unsplash.com/photo-1461749280684-dccba630e2f6?w=800&h=500&fit=crop',
                'startup': 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?w=800&h=500&fit=crop',
                'privacy': 'https://images.unsplash.com/photo-1563986768609-322da13575f3?w=800&h=500&fit=crop',
                'technology': 'https://images.unsplash.com/photo-1518770660439-4636190af475?w=800&h=500&fit=crop',
                'thoughts': 'https://images.unsplash.com/photo-1499750310107-5fef28a66643?w=800&h=500&fit=crop',
                'agent': 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=800&h=500&fit=crop',
                'default': 'https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=800&h=500&fit=crop'
            };

            if (tags && tags.length > 0) {
                const tag = tags[0].toLowerCase();
                // Check for partial matches
                for (const [key, url] of Object.entries(tagImages)) {
                    if (tag.includes(key) || key.includes(tag)) {
                        return url;
                    }
                }
            }
            return tagImages.default;
        }

        /**
         * Load and render the post
         */
        async function loadPost() {
            const params = new URLSearchParams(window.location.search);
            const slug = params.get('slug');

            if (!slug) {
                document.getElementById('post-content').innerHTML = `
                    <div class="post-error">
                        <h1>Post Not Found</h1>
                        <p>No post specified. <a href="/blog">Return to blog</a></p>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`posts/${slug}.md`);
                if (!response.ok) throw new Error('Post not found');

                const text = await response.text();
                const { metadata, content } = parseFrontmatter(text);

                // Update page title
                document.title = `${metadata.title || 'Post'} | Bitroot Blog`;

                // Calculate read time
                const readTime = Math.ceil(content.split(/\s+/).length / 200);

                // Render post
                const tag = (metadata.tags && metadata.tags[0]) || 'General';
                const html = marked.parse(content);

                // Get image - use metadata image, or fallback to tag-based image
                // Skip deprecated unsplash source URLs
                let heroImage = metadata.image;
                if (!heroImage || heroImage.includes('source.unsplash.com')) {
                    heroImage = getTagImage(metadata.tags);
                }

                // Check if we have a video (local or remote)
                const hasVideo = metadata.video && !metadata.video.includes('twimg.com');
                const isGif = metadata.video && (metadata.video.includes('.gif') || metadata.video.includes('gif'));

                // Format date - use published_at if available, otherwise fallback to date
                const displayDate = metadata.published_at ? formatDateTime(metadata.published_at) : formatDate(metadata.date);

                document.getElementById('post-content').innerHTML = `
                    ${hasVideo ? `
                        <div class="post-hero-video">
                            <video
                                id="hero-video"
                                src="${metadata.video}"
                                playsinline
                                loop
                                muted
                                autoplay
                                poster="${heroImage}"
                                onerror="this.parentElement.innerHTML='<div class=\\'post-hero-image\\'><img src=\\'${heroImage}\\' alt=\\'${metadata.title || 'Post image'}\\'></div>'"
                            >
                                Your browser does not support the video tag.
                            </video>
                            <button class="video-mute-btn" id="mute-btn" aria-label="Toggle sound">
                                <svg class="muted-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                    <line x1="23" y1="9" x2="17" y2="15"></line>
                                    <line x1="17" y1="9" x2="23" y2="15"></line>
                                </svg>
                                <svg class="unmuted-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                                </svg>
                            </button>
                        </div>
                    ` : `
                        <div class="post-hero-image">
                            <img src="${heroImage}" alt="${metadata.title || 'Post image'}" onerror="this.src='${getTagImage(metadata.tags)}'">
                        </div>
                    `}
                    <header class="post-header">
                        <div class="post-meta">
                            <span class="post-tag">${tag}</span>
                            <span class="post-date">${displayDate}</span>
                            <span class="post-read-time">${readTime} min read</span>
                        </div>
                        <h1 class="post-title">${metadata.title || 'Untitled'}</h1>
                    </header>
                    <div class="post-body">
                        ${html}
                    </div>
                    <nav class="post-nav">
                        <a href="/blog" class="back-link">&larr; Back to blog</a>
                        ${metadata.sources && metadata.sources.length > 0 ? `
                            <a href="${metadata.sources[0]}" target="_blank" rel="noopener" class="source-link" title="View original source">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </a>
                        ` : ''}
                    </nav>
                `;

                // Setup video mute toggle if video exists
                const video = document.getElementById('hero-video');
                const muteBtn = document.getElementById('mute-btn');
                if (video && muteBtn) {
                    muteBtn.addEventListener('click', () => {
                        video.muted = !video.muted;
                        const mutedIcon = muteBtn.querySelector('.muted-icon');
                        const unmutedIcon = muteBtn.querySelector('.unmuted-icon');
                        if (video.muted) {
                            mutedIcon.style.display = 'block';
                            unmutedIcon.style.display = 'none';
                        } else {
                            mutedIcon.style.display = 'none';
                            unmutedIcon.style.display = 'block';
                        }
                    });
                }

            } catch (e) {
                document.getElementById('post-content').innerHTML = `
                    <div class="post-error">
                        <h1>Post Not Found</h1>
                        <p>The requested post could not be found. <a href="/blog">Return to blog</a></p>
                    </div>
                `;
            }
        }

        document.addEventListener('DOMContentLoaded', loadPost);
    </script>
</body>
</html>
